{% extends "base.html" %}
{% block content %}
<div class="container py-4">
    <form method="get" class="row g-2 mb-3 align-items-center">
        <div class="col-md-4">
          <input class="form-control" type="text" name="q" value="{{ q }}" placeholder="Search songs, artists...">
        </div>
        <div class="col-md-2">
          <select class="form-select" name="genre">
            <option value="">All Genres</option>
            {% for val,label in genres %}
              <option value="{{ val }}" {% if genre == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" name="language">
            <option value="">All Languages</option>
            {% for val,label in languages %}
              <option value="{{ val }}" {% if language == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" name="artist">
            <option value="">All Artists</option>
            {% for a in artists %}
              <option value="{{ a.id }}" {% if artist_id|default:'' == a.id|stringformat:'s' %}selected{% endif %}>{{ a.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 d-flex gap-2">
          <button type="submit" class="btn btn-dark flex-fill">Filter</button>
          <a href="{% url 'songs:home' %}" class="btn btn-dark flex-fill">Clear</a>
        </div>
      </form>
      
  {% if request.user.is_authenticated and request.user.is_staff or request.user.is_authenticated and request.user.profile.can_upload %}
  <div class="mb-3">
      <a class="btn btn-outline-dark" href="{% url 'songs:song_create' %}">+ Upload Song</a>
  </div>
{% endif %}

  <!-- Netflix-style grid -->
  <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-6 g-3">
    {% for song in page_obj.object_list %}
      <div class="col">
        <div class="card h-100 shadow-sm border-0 bg-dark text-white" style="cursor:pointer"
             onclick="openPlayer('{{ song.id }}', '{{ song.name|escapejs }}', '{{ song.audio.url }}', '{{ song.image.url }}')">
          <img src="{{ song.image.url }}" class="card-img-top" alt="{{ song.name }}" style="aspect-ratio:1/1; object-fit:cover;">
          <div class="card-body p-2">
            <div class="fw-semibold small text-truncate">{{ song.name }}</div>
            <div class="text-muted small">{{ song.get_genre_display }} • {{ song.get_language_display }}</div>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No songs found.</p>
    {% endfor %}
  </div>

  <nav class="mt-4">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&genre={{ genre }}&language={{ language }}&artist={{ artist_id }}">Prev</a></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&genre={{ genre }}&language={{ language }}&artist={{ artist_id }}">Next</a></li>
      {% endif %}
    </ul>
  </nav>
</div>

<!-- Modal Player -->
<div class="modal fade" id="playerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="playerTitle">Playing</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <img id="playerImage" src="" class="w-100 mb-3 rounded" style="max-height:320px; object-fit:cover;">
        <audio id="playerAudio" controls style="width:100%"></audio>
      </div>
    </div>
  </div>
</div>

<!-- Mini player -->
<div id="mini" class="position-fixed bottom-0 start-50 translate-middle-x w-100" style="max-width:860px; z-index:1040; display:none;">
  <div class="card shadow-lg border-0 rounded-top bg-dark text-white">
    <div class="card-body d-flex align-items-center gap-3">
      <img id="miniImg" src="" style="width:56px;height:56px;object-fit:cover;border-radius:8px;">
      <div class="flex-grow-1">
        <div id="miniTitle" class="fw-semibold small"></div>
        <audio id="miniAudio" controls style="width:100%"></audio>
      </div>
      <button class="btn btn-outline-light btn-sm" onclick="document.getElementById('mini').style.display='none'">Minimize</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const modal = new bootstrap.Modal(document.getElementById('playerModal'));
  const titleEl = document.getElementById('playerTitle');
  const audioEl = document.getElementById('playerAudio');
  const imgEl = document.getElementById('playerImage');

  const mini = document.getElementById('mini');
  const miniAudio = document.getElementById('miniAudio');
  const miniImg = document.getElementById('miniImg');
  const miniTitle = document.getElementById('miniTitle');

  function openPlayer(id, title, audioUrl, imgUrl) {
    titleEl.textContent = title;
    audioEl.src = audioUrl;
    imgEl.src = imgUrl;
    audioEl.play().catch(()=>{});
    modal.show();

    // log play later (Step 6) via fetch('/play/...')
  }

  // when modal closes → keep playing in mini player
  document.getElementById('playerModal').addEventListener('hidden.bs.modal', () => {
    mini.style.display = 'block';
    miniAudio.src = audioEl.src;
    miniImg.src = imgEl.src;
    miniTitle.textContent = titleEl.textContent;
    miniAudio.currentTime = audioEl.currentTime;
    if (!audioEl.paused) miniAudio.play().catch(()=>{});
    audioEl.pause();
  });
</script>
{% endblock %}
